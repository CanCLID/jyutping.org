---
import { IconMenu2 } from "@tabler/icons-react";
import LanguageSwitcher from "@/components/LanguageSwitcher.tsx";

const { currentLocale, url } = Astro;
const pathname = url.pathname;
const locale = currentLocale || "yue";

// --- Navigation Translations ---
const navTranslations: Record<string, Record<string, string>> = {
  learn: {
    cmn: "學粵拼",
    en: "Learn Jyutping",
    ja: "粤拼を学ぶ",
    nan: "學粵拼",
    vi: "Học Việt bính",
    wuu: "學粵拼",
    yue: "學粵拼",
    yue_hans: "学粤拼",
  },
  jyutping: {
    cmn: "粵拼方案",
    en: "Jyutping Scheme",
    ja: "粤拼便覧",
    nan: "粵拼方案",
    vi: "Việt bính",
    wuu: "粵拼方案",
    yue: "粵拼方案",
    yue_hans: "粤拼方案",
  },
  blog: {
    cmn: "文章",
    en: "Blog",
    ja: "ブログ",
    nan: "文章",
    vi: "Tập văn",
    wuu: "文章",
    yue: "文章",
    yue_hans: "文章",
  },
  keyboard: {
    cmn: "資源",
    en: "Resources",
    ja: "リソース",
    nan: "資源",
    vi: "Tài liệu",
    wuu: "資源",
    yue: "資源",
    yue_hans: "资源",
  },
  about: {
    cmn: "關於",
    en: "About",
    ja: "当サイトについて",
    nan: "關於",
    vi: "Liên lạc",
    wuu: "關於",
    yue: "關於",
    yue_hans: "关于",
  },
};

// --- Generate Localized Nav Links ---
const navLinkKeys = ["learn", "jyutping", "blog", "keyboard", "about"];
const navLinks = navLinkKeys.map((key) => {
  const baseHref = `/${key}`;
  // Prepend locale prefix only if it's not the default locale
  const href = locale === "yue" ? baseHref : `/${locale}${baseHref}`;
  return {
    href: href,
    title: navTranslations[key]?.[locale] || key,
  };
});

// Determine the correct base path for the logo link
const logoHref = locale === "yue" ? "/" : `/${locale}`;

const locales = ["en", "vi", "yue", "cmn", "nan", "wuu", "yue_hans", "ja"];
const defaultLocale = "yue";
---

<header class="relative p-4 bg-[#1678d3] text-white">
  <div class="flex justify-between items-center px-4">
    <a href={logoHref} class="text-white hover:opacity-80">
      <span class="text-3xl font-jyutping">粵拼</span>
    </a>

    {/* Desktop Navigation */}
    <nav class="hidden md:flex space-x-12">
      {
        navLinks.map((link) => (
          <a href={link.href} class="text-white text-lg hover:opacity-90">
            {link.title}
          </a>
        ))
      }
    </nav>

    {/* Desktop Language Switcher */}
    <div class="hidden md:block">
      <LanguageSwitcher
        locales={locales}
        defaultLocale={defaultLocale}
        currentPathname={pathname}
        client:load
      />
    </div>

    {/* Mobile Menu Button */}
    <button
      type="button"
      class="md:hidden text-white cursor-pointer"
      aria-label="Toggle menu"
      id="mobile-menu-button"
    >
      <IconMenu2 size={24} />
    </button>

    {/* Mobile Menu Panel (hidden by default) */}
    <div
      id="mobile-menu-panel"
      class="bg-[#1678d3] text-white absolute top-full left-0 right-0 z-50 shadow-md md:hidden hidden"
    >
      <div class="px-8 py-4 flex flex-col space-y-4">
        {/* Mobile Navigation Links */}
        <nav class="flex flex-col space-y-2">
          {
            navLinks.map((link) => (
              <a href={link.href} class="text-white text-lg hover:opacity-80">
                {link.title}
              </a>
            ))
          }
        </nav>
        {/* Mobile Language Switcher */}
        <LanguageSwitcher
          locales={locales}
          defaultLocale={defaultLocale}
          currentPathname={pathname}
          client:load
        />
      </div>
    </div>
  </div>
</header>

<script>
  function setupMobileMenu() {
    const menuButton = document.getElementById("mobile-menu-button");
    const menuPanel = document.getElementById("mobile-menu-panel");

    if (menuButton && menuPanel) {
      // Remove potential old listener to prevent duplicates if script runs multiple times
      // (Though astro:page-load should handle this, it's safer)
      // Clone the button to effectively remove old listeners before adding new ones
      const newButton = menuButton.cloneNode(true);
      if (menuButton.parentNode) {
        menuButton.parentNode.replaceChild(newButton, menuButton);
      } else {
        console.error("Menu button has no parent node.");
        return; // Exit if we can't replace the button
      }

      newButton.addEventListener("click", () => {
        menuPanel.classList.toggle("hidden");
      });

      // Close menu when a link inside it is clicked
      // Re-query links inside the panel each time to ensure they are fresh
      menuPanel.querySelectorAll("a").forEach((link) => {
        // Clone links as well to remove potential old listeners
        const newLink = link.cloneNode(true);
        if (link.parentNode) {
          link.parentNode.replaceChild(newLink, link);
        } else {
          console.warn("Menu link has no parent node during setup.");
          // Attempt to add listener to original link as fallback, though it might be stale
          link.addEventListener("click", () => {
            if (!menuPanel.classList.contains("hidden")) {
              menuPanel.classList.add("hidden");
            }
          });
          return; // Continue to next link
        }

        newLink.addEventListener("click", () => {
          if (!menuPanel.classList.contains("hidden")) {
            menuPanel.classList.add("hidden");
          }
        });
      });
    } else {
      console.log("Mobile menu button or panel not found after page load.");
    }
  }

  // Run on initial page load
  setupMobileMenu();

  // Run after Astro navigations
  document.addEventListener("astro:page-load", setupMobileMenu);
</script>
