---
import { getCollection } from "astro:content";
import BaseLayout from "@/layouts/BaseLayout.astro";
import BlogIndexList from "@/components/BlogIndexList.tsx";
import { I18n } from "@/i18n/utils";
import { getTitle } from "@/i18n/pageHeadings";
import { getBlogLabels } from "@/i18n/blogLabels";

export function getStaticPaths() {
  const result = I18n.locales
    .filter((locale) => locale !== I18n.defaultLocale)
    .map((locale) => ({
      params: { locale },
    }));
  return result;
}

const { locale } = Astro.params;

// Validate locale
const validLocale = I18n.locales.includes(locale as string)
  ? locale
  : I18n.defaultLocale;

// Fetch blog posts for the current locale
const postsData = await getCollection("blog", ({ id }) =>
  id.startsWith(`${validLocale}/`)
);

// Prepare posts prop for the component
const posts = postsData.map((post) => ({
  title: post.data.title,
  slug: `/${validLocale}/blog/${post.slug.substring(validLocale.length + 1)}`,
  description: post.data.description,
}));

// Get translations for the current locale
const title = getTitle("blog", validLocale);
const blogLabels = getBlogLabels(validLocale);
---

<BaseLayout lang={validLocale} title={title}>
  <BlogIndexList posts={posts} translations={{ title, ...blogLabels }} client:load />
</BaseLayout>
